<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†ç´€éŒ„ç³»çµ± - çœŸå¯¦ AI è£œå…¨ç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å°èˆªåˆ— */
        .navbar {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .navbar h1 {
            color: #667eea;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* æ¨™é¡Œä¸Šçš„ AI æ¨™ç±¤ */
        .navbar h1 .ai-tag {
            font-size: 14px;
            padding: 4px 8px;
            background: #FFD700; 
            color: #333;
            border-radius: 8px;
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }


        .navbar .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .menu-toggle {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .menu-toggle:hover {
            background: #f3f4f6;
            transform: scale(1.05);
        }

        /* é é¢å…§å®¹ */
        .page-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¡¨å–®å®¹å™¨ */
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-header h2 {
            color: #333;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* é›™æ¬„æ ¼ */
        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: #ef4444;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .custom-select {
            position: relative;
        }

        .custom-select select {
            appearance: none;
            background: white url('data:image/svg+xml;utf8,<svg fill="%23666" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
            background-size: 20px;
            cursor: pointer;
            padding-right: 40px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        /* ç´€éŒ„åˆ—è¡¨ */
        .record-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .record-list-header {
            padding: 25px 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .record-list-header h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
            display: flex; 
        }
        
        .search-input-group {
            flex-grow: 1;
            display: flex;
        }

        .search-box input {
            flex-grow: 1;
            padding: 12px 15px 12px 45px;
            border: 2px solid #e5e7eb;
            border-right: none;
            border-radius: 10px 0 0 10px;
            font-size: 15px;
        }

        .search-box::before {
            content: "ğŸ”";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            pointer-events: none; 
            z-index: 10;
        }
        
        .search-button {
            padding: 0 15px;
            border: 2px solid #e5e7eb;
            border-left: none;
            border-radius: 0 10px 10px 0;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 18px;
            color: #666;
        }
        
        .search-button:hover {
            background: #e5e7eb;
        }
        
        /* éš±è—åŸç”Ÿæœå°‹åœ–ç¤º */
        .search-box input::-webkit-search-decoration,
        .search-box input::-webkit-search-cancel-button,
        .search-box input::-webkit-search-results-button,
        .search-box input::-webkit-search-results-decoration {
            display: none;
        }


        .filter-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        thead th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s ease;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        tbody td {
            padding: 20px;
            color: #333;
        }

        .patient-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .patient-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .patient-details .name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .patient-details .id {
            font-size: 13px;
            color: #999;
        }

        .status-badge {
            display: inline-flex;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.view {
            background: #dbeafe;
            color: #1e40af;
        }

        .action-btn.edit {
            background: #d1fae5;
            color: #065f46;
        }
        
        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }


        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-buttons button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-buttons button:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .pagination-buttons button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            transform: translateX(400px);
        }

        .success-message.show {
            animation: slideInRight 0.5s ease forwards;
        }

        .success-message.hide {
            animation: slideOutRight 0.5s ease forwards;
        }

        @keyframes slideInRight {
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(400px);
            }
        }

        .success-icon {
            width: 40px;
            height: 40px;
            background: #d1fae5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Loading å‹•ç•« */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .settings-content {
            display: none;
        }

        .settings-content.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        /* ç´€éŒ„é è¦½å¡ç‰‡æ¨£å¼ */
        .record-preview-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative; /* for action buttons */
        }
        .record-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
            flex-wrap: wrap; /* RWD */
            gap: 10px;
        }
        
        .record-item-header .record-actions {
            display: flex;
            gap: 10px;
        }

        .record-preview-item p {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #333;
            /* è®“æ›è¡Œç¬¦è™Ÿç”Ÿæ•ˆ */
            white-space: pre-wrap;
        }
        
        /* ç´€éŒ„ç·¨è¼¯å€åŸŸ */
        .record-edit-area {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
            display: none;
        }
        .record-edit-area.active {
            display: block;
        }
        
        /* ç´€éŒ„ç·¨è¼¯æŒ‰éˆ• */
        .record-edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .record-edit-buttons .btn {
            padding: 8px 20px;
            font-size: 14px;
        }
        
        .record-edit-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        .record-edit-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* --- Copilot æ ¸å¿ƒ CSS --- */
        /* æ–°å¢ï¼šç”¨æ–¼åŒ…è£¹æ‰€æœ‰ç´€éŒ„è¼¸å…¥å€å¡Šçš„å®¹å™¨ */
        #recordInputsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px; /* æ¯å€‹è¼¸å…¥å€å¡Šä¹‹é–“çš„é–“è· */
        }

        /* æ–°å¢ï¼šå‹•æ…‹æ’å…¥çš„å–®å€‹ç´€éŒ„å€å¡Š */
        .record-input-block {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            background: #fcfcfc;
            position: relative;
        }

        /* æ–°å¢ï¼šç§»é™¤æŒ‰éˆ•æ¨£å¼ */
        .btn-remove-block {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
            z-index: 10;
        }
        .btn-remove-block:hover {
            color: #ef4444;
        }

        /* æ–°å¢ï¼šæ’å…¥æ–°å€å¡Šçš„æŒ‰éˆ•å®¹å™¨ */
        .add-block-container {
            display: flex;
            justify-content: center; /* è®“æŒ‰éˆ•å±…ä¸­ */
            margin-top: 15px;
        }

        .btn-add-block {
            background: #667eea;
            color: white;
            padding: 10px;
            border-radius: 50%; /* è®Šæˆåœ“å½¢æŒ‰éˆ• */
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            line-height: 1;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
            font-weight: bold;
        }

        .btn-add-block:hover {
            transform: scale(1.1);
            background: #764ba2;
        }


        /* æ¯å€‹è¼¸å…¥å¡Šçš„ AI çµæ§‹ */
        .copilot-container {
            position: relative;
            /* ç¹¼æ‰¿ form-group çš„æ¨£å¼ */
        }

        .record-textarea {
            width: 100%;
            background-color: transparent; 
            color: #333; 
            z-index: 3; 
            position: relative;
            
            /* ç¢ºä¿èˆ‡ Overlay çš„é‚Šæ¡†ã€å…§é‚Šè·ã€åœ“è§’å®Œå…¨åŒæ­¥ */
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            min-height: 150px; /* åˆå§‹é«˜åº¦èª¿ä½ä¸€é» */
            resize: vertical;

            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            font-size: 15px;
            line-height: 1.5; 
            white-space: pre-wrap; 
            overflow: auto; 
        }
        .record-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .suggestion-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; 
            color: #ccc; 
            
            /* å¿…é ˆèˆ‡ Textarea ç›¸åŒ */
            padding: 12px 15px; 
            border-radius: 10px; 
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            font-size: 15px;
            line-height: 1.5; 
            white-space: pre-wrap; 
            pointer-events: none;
            overflow: auto; 
            
            /* ç¢ºä¿ Overlay é‚Šç•Œåœ¨ Textarea é‚Šç•Œä¹‹å…§ */
            border: 2px solid transparent; 
        }
        /* --- Copilot æ ¸å¿ƒ CSS çµæŸ --- */


        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-grid, .form-grid-2 {
                grid-template-columns: 1fr;
            }

            .search-filters {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .table-container {
                overflow-x: scroll;
            }

            table {
                min-width: 800px;
            }
        }

        /* ç™»å…¥é é¢æ¨£å¼ */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        
        .login-container input[type="text"],
        .login-container input[type="password"] {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }
        
        .login-container button {
            width: 100%;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div id="successMessage" class="success-message">
        <div class="success-icon">âœ“</div>
        <div>
            <strong>æ“ä½œæˆåŠŸï¼</strong>
            <p style="margin: 5px 0 0; color: #666; font-size: 14px;">è­·ç†ç´€éŒ„å·²å„²å­˜</p>
        </div>
    </div>
    
    <div id="login" class="page-content active">
        <div class="login-container">
            <h2>ğŸ¥ ç³»çµ±ç™»å…¥</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>å“¡å·¥ç·¨è™Ÿ/ID</label>
                    <input type="text" id="loginId" value="N001" required="" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ/ID">
                </div>
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" value="1234" required="" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 15px;">
                    ç™»å…¥ç³»çµ±
                </button>
            </form>
            <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #999;">ç¤ºç¯„å¸³è™Ÿï¼šN001 / 1234</p>
        </div>
    </div>
    <div class="container" id="mainApp" style="display: none;">
        <nav class="navbar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1 onclick="switchPage('patients')">ğŸ¥ è­·ç†ç´€éŒ„ç³»çµ± <span class="ai-tag">çœŸå¯¦ AI è£œå…¨</span></h1>
            </div>
            <div class="user-info">
                <div>
                    <div style="font-weight: 500; color: #333;" id="navUserName">å¼µè­·ç†å¸«</div>
                    <div style="font-size: 13px; color: #999;" id="navUserDetail">è³‡æ·±è­·ç†å¸« Â· å…§ç§‘</div>
                </div>
                <div class="user-avatar" id="navUserAvatar" onclick="switchPage('settings')">å¼µ</div>
            </div>
        </nav>

        
        <div id="form" class="page-content">
            <div class="form-container">
                <div class="form-header">
                    <h2>æ–°å¢ <span id="formPatientName" style="color: #667eea;">ç—…æ‚£</span> çš„è­·ç†ç´€éŒ„</h2>
                    <button class="btn btn-secondary" onclick="cancelRecordForm()">â† è¿”å›åˆ—è¡¨</button>
                </div>

                <form id="recordForm" onsubmit="submitForm(event)">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 18px;">åŸºæœ¬è³‡è¨Š</h3>
                    
                    <div class="form-group">
                        <label>ç´€éŒ„æ™‚é–“ <span class="required">*</span></label>
                        <input type="datetime-local" id="recordTime" required="">
                    </div>
                        
                    <div class="form-group" style="margin-top: 30px;">
                        <label>è­·ç†ç´€éŒ„å…§å®¹ (DART æ ¼å¼) <span class="required">*</span></label>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">æ‚¨å¯ä»¥ä½¿ç”¨ **F) å‘¼å¸æ€¥ä¿ƒ** æˆ– **F) å‚·å£** ç­‰é—œéµå­—é«”é©— AI è£œå…¨ã€‚æŒ‰ **Tab** æ¥å—ï¼Œ**â†‘/â†“** åˆ‡æ›å»ºè­°ã€‚</p>
                        
                        <div id="recordInputsContainer">
                            </div>

                        <div class="add-block-container">
                            <button type="button" class="btn-add-block" title="æ–°å¢ä¸€æ ¼ç´€éŒ„å€å¡Š" onclick="addRecordInput()">+</button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">æ¸…é™¤æ‰€æœ‰å…§å®¹</button>
                        <button type="submit" class="btn btn-primary">
                            âœ“ å„²å­˜ç´€éŒ„ (å°‡åˆä½µæ‰€æœ‰å€å¡Šå…§å®¹)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="patients" class="page-content">
            <div class="record-list">
                <div class="record-list-header">
                    <h2>ç—…æ‚£ç®¡ç†</h2>
                    <div class="search-filters">
                        <div class="search-box">
                            <input type="text" id="patientSearchInput" placeholder="æœå°‹ç—…æ‚£å§“åæˆ–ç—…æ­·è™Ÿ..." onkeypress="if(event.keyCode==13) searchPatients()">
                            <button class="search-button" onclick="searchPatients()">ğŸ”</button>
                        </div>
                        <select class="filter-btn">
                            <option value="">æ‰€æœ‰ç§‘åˆ¥</option>
                            <option value="internal">å…§ç§‘</option>
                            <option value="surgery">å¤–ç§‘</option>
                            <option value="orthopedics">éª¨ç§‘</option>
                            <option value="urology">æ³Œå°¿ç§‘</option>
                        </select>
                        <button class="btn btn-primary" onclick="switchPage('addPatientForm')">
                            â• æ–°å¢ç—…æ‚£
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ç—…æ‚£è³‡è¨Š</th>
                                <th>ç—…æˆ¿åºŠè™Ÿ</th>
                                <th>ç§‘åˆ¥</th>
                                <th>è¨ºæ–·</th>
                                <th>é¢¨éšªç­‰ç´š</th>
                                <th>ä¸»æ²»é†«å¸«</th>
                                <th>å…¥é™¢æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patientTableBody">
                            </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <div class="pagination-info">ç›®å‰ç„¡ç—…æ‚£è³‡æ–™</div>
                    <div class="pagination-buttons">
                        <button>ä¸Šä¸€é </button>
                        <button class="active">1</button>
                        <button>ä¸‹ä¸€é </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="page-content">
            <div class="form-container">
                <div class="form-header">
                    <div>
                        <h2>ç³»çµ±è¨­å®š</h2>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">ç®¡ç†æ‚¨çš„å€‹äººæª”æ¡ˆå’Œç³»çµ±é…ç½®</p>
                    </div>
                </div>

                <div id="profileSettings" class="settings-content active">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 15px;">
                        <div class="user-avatar" id="settingUserAvatar" style="width: 80px; height: 80px; font-size: 32px;">å¼µ</div>
                        <div style="flex: 1;">
                            <h3 style="font-size: 20px; color: #333; margin-bottom: 5px;" id="settingUserNameDisplay">å¼µè­·ç†å¸«</h3>
                            <p style="color: #666; margin-bottom: 10px;" id="settingUserDetailDisplay">è³‡æ·±è­·ç†å¸« Â· å…§ç§‘</p>
                            <button class="btn btn-secondary" style="padding: 8px 20px;">æ›´æ›é ­åƒ</button>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="settingNameInput" value="å¼µè­·ç†å¸«" placeholder="è«‹è¼¸å…¥å§“å" oninput="updateProfileDisplay()">
                        </div>
                        <div class="form-group">
                            <label>å“¡å·¥ç·¨è™Ÿ</label>
                            <input type="text" id="settingIdInput" value="N001" placeholder="å“¡å·¥ç·¨è™Ÿ" readonly>
                        </div>
                        <div class="form-group">
                            <label>é›»å­éƒµä»¶</label>
                            <input type="email" id="settingEmailInput" value="nurse.chang@hospital.com" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>è¯çµ¡é›»è©±</label>
                            <input type="tel" id="settingPhoneInput" value="0912-345-678" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                        </div>
                        <div class="form-group custom-select">
                            <label>ç§‘åˆ¥</label>
                            <select id="settingDeptSelect" onchange="updateProfileDisplay()">
                                <option value="å…§ç§‘">å…§ç§‘</option>
                                <option value="å¤–ç§‘">å¤–ç§‘</option>
                                <option value="éª¨ç§‘">éª¨ç§‘</option>
                                <option value="æ³Œå°¿ç§‘">æ³Œå°¿ç§‘</option>
                                <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è·ä½</label>
                            <input type="text" id="settingPositionInput" value="è³‡æ·±è­·ç†å¸«" placeholder="è·ä½" oninput="updateProfileDisplay()">
                        </div>
                    </div>
<h3 style="color: #333; font-size: 18px; margin-bottom: 20px;">å¯†ç¢¼è¨­å®š</h3>
                    
                    <div class="form-group" style="max-width: 500px;">
                        <label>ç›®å‰å¯†ç¢¼</label>
                        <input type="password" id="currentPassword" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼">
                    </div>
                    <div class="form-group" style="max-width: 500px;">
                        <label>æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <div class="form-group" style="max-width: 500px; margin-bottom: 30px;">
                        <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input type="password" id="confirmNewPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" onclick="switchPage('patients')">å–æ¶ˆ</button>
                        <button class="btn btn-primary" type="button" onclick="saveSettings()">ğŸ’¾ å„²å­˜æ›´æ–°</button>
                    </div>
                    
                    <div style="border-top: 2px solid #f0f0f0; padding-top: 20px; margin-top: 30px; text-align: right;">
                        <button class="btn btn-danger" type="button" onclick="logout()">
                            ğŸšª ç™»å‡ºç³»çµ±
                        </button>
                    </div>
                    
                </div>
            </div>
        </div>

        <div id="addPatientForm" class="page-content">
            <div class="form-container">
                <div class="form-header">
                    <h2>æ–°å¢ç—…æ‚£</h2>
                    <button class="btn btn-secondary" onclick="switchPage('patients')">â† è¿”å›åˆ—è¡¨</button>
                </div>

                <form id="newPatientForm" onsubmit="submitNewPatient(event)">
                    <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 20px; font-size: 18px;">ä½é™¢è³‡è¨Š</h3>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label>ç—…æ‚£å§“å <span class="required">*</span></label>
                            <input type="text" id="newPatientName" placeholder="è«‹è¼¸å…¥å§“å" required="">
                        </div>
                        <div class="form-group">
                            <label>ç—…æ­·è™Ÿ <span class="required">*</span></label>
                            <input type="text" id="newPatientId" placeholder="ä¾‹ï¼šP006" required="">
                        </div>
                        <div class="form-group">
                            <label>å¹´é½¡ <span class="required">*</span></label>
                            <input type="number" id="newPatientAge" placeholder="è«‹è¼¸å…¥å¹´é½¡" required="">
                        </div>
                        <div class="form-group custom-select">
                            <label>æ€§åˆ¥ <span class="required">*</span></label>
                            <select id="newPatientGender" required="">
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 20px; font-size: 18px;">ä½é™¢è³‡è¨Š</h3>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label>ç—…æˆ¿åºŠè™Ÿ <span class="required">*</span></label>
                            <input type="text" id="newPatientBed" placeholder="ä¾‹ï¼šA101-2" required="">
                        </div>
                        <div class="form-group custom-select">
                            <label>ç§‘åˆ¥ <span class="required">*</span></label>
                            <select id="newPatientDept" required="">
                                <option value="å…§ç§‘">å…§ç§‘</option>
                                <option value="å¤–ç§‘">å¤–ç§‘</option>
                                <option value="éª¨ç§‘">éª¨ç§‘</option>
                                <option value="æ³Œå°¿ç§‘">æ³Œå°¿ç§‘</option>
                                <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¨ºæ–· <span class="required">*</span></label>
                            <input type="text" id="newPatientDiagnosis" placeholder="è«‹è¼¸å…¥ä¸»è¦è¨ºæ–·" required="">
                        </div>
                        <div class="form-group custom-select">
                            <label>é¢¨éšªç­‰ç´š <span class="required">*</span></label>
                            <select id="newPatientRisk" required="">
                                <option value="ä½é¢¨éšª">ä½é¢¨éšª</option>
                                <option value="ä¸­é¢¨éšª">ä¸­é¢¨éšª</option>
                                <option value="é«˜é¢¨éšª">é«˜é¢¨éšª</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¸»æ²»é†«å¸« <span class="required">*</span></label>
                            <input type="text" id="newPatientDoctor" placeholder="è«‹è¼¸å…¥é†«å¸«å§“å" required="">
                        </div>
                        <div class="form-group">
                            <label>å…¥é™¢æ—¥æœŸ <span class="required">*</span></label>
                            <input type="date" id="newPatientAdmissionDate" required="">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="switchPage('patients')">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="submitNewPatient(event)">
                            âœ“ å„²å­˜ç—…æ‚£
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="patientRecordPreview" class="page-content">
            <div class="form-container">
                <div class="form-header">
                    <div>
                        <h2><span id="previewPatientName">ç—…æ‚£</span> çš„è­·ç†ç´€éŒ„</h2>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">é è¦½è©²ç—…æ‚£å…ˆå‰å„²å­˜éçš„è­·ç†ç´€éŒ„</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="addNewRecordBtn" onclick="openRecordFormForPreview()">
                            + æ–°å¢è­·ç†ç´€éŒ„
                        </button>
                        <button class="btn btn-secondary" onclick="switchPage('patients')">â† è¿”å›åˆ—è¡¨</button>
                    </div>
                </div>

                <div id="recordPreviewList">
                    </div>
            </div>
        </div>

    </div>
    <script>
        
        // =================================================================
        // ğŸš¨ğŸš¨ çœŸå¯¦ API å‘¼å«è¨­å®š ğŸš¨ğŸš¨
        // =================================================================
        const REAL_API_SETTINGS = {
             // æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„å¾Œç«¯æœå‹™ URL (èˆ‡ api_server.py çš„è¨­å®šä¸€è‡´)
            API_ENDPOINT: 'https://MarcoLeung052-nursing-copilot-api.hf.space/api/predict', 
             API_KEY: null, 
             TIMEOUT_MS: 15000 
        };

        // =================================================================
        // Copilot æ ¸å¿ƒç‹€æ…‹åŠåŠŸèƒ½
        // =================================================================
        
        // å…¨å±€ç‹€æ…‹ï¼šç”¨æ–¼ç®¡ç†å¤šå€‹è¼¸å…¥æ¡†çš„ AI å»ºè­°ç‹€æ…‹
        // Key: input ID (e.g., 'recordInput-1'), Value: { suggestions: [], currentSuggestionIndex: 0 }
        let inputStates = new Map(); 
        let inputCounter = 0; // ç”¨æ–¼ç”Ÿæˆå”¯ä¸€çš„ ID
        let apiCallTimeouts = new Map(); // ç”¨æ–¼ç®¡ç†æ¯å€‹è¼¸å…¥æ¡†çš„é˜²æŠ–è¨ˆæ™‚å™¨

        const DEBOUNCE_DELAY = 500; 
        const MIN_PROMPT_LENGTH = 3; 

        // -----------------------------------------------------------------
        // API å‘¼å« (ä¿æŒä¸è®Š)
        // -----------------------------------------------------------------
        async function predictText(prompt) {
             const { API_ENDPOINT, API_KEY, TIMEOUT_MS } = REAL_API_SETTINGS;
             
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);
             
             try {
                 const headers = { 
                     'Content-Type': 'application/json',
                 };
                 if (API_KEY) {
                     headers['Authorization'] = `Bearer ${API_KEY}`; 
                 }
                 
                 const response = await fetch(API_ENDPOINT, {
                     method: 'POST',
                     headers: headers,
                     body: JSON.stringify({ 
                         prompt: prompt, 
                         patient_id: currentEditingPatientId, 
                         model: 'gpt2-nursing'
                     }),
                     signal: controller.signal 
                 });
                 
                 clearTimeout(timeoutId); 
                 
                 if (!response.ok) {
                     const errorBody = await response.text();
                     // åƒ…åœ¨éŒ¯èª¤ç™¼ç”Ÿæ™‚å½ˆå‡ºæç¤º
                     // alert(`å¾Œç«¯ AI æœå‹™éŒ¯èª¤ï¼šHTTP ${response.status} - è«‹æª¢æŸ¥å¾Œç«¯ä¸»æ§å°ã€‚\néŒ¯èª¤è¨Šæ¯: ${errorBody.substring(0, 100)}`);
                     throw new Error(`å¾Œç«¯ API éŒ¯èª¤ï¼š${response.status}`);
                 }

                 const data = await response.json();
                 
                 return {
                     alternatives: data.completions || [] 
                 };
                 
             } catch (error) {
                 clearTimeout(timeoutId);
                 if (error.name === 'AbortError') {
                     console.error("API å‘¼å«è¶…æ™‚:", API_ENDPOINT);
                     // alert('AI æœå‹™è«‹æ±‚è¶…æ™‚ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œã€‚');
                 } else {
                     console.error("API å‘¼å«å¤±æ•—:", error.message);
                 }
                 throw error; 
             }
        }


        // -----------------------------------------------------------------
        // ğŸ”¥ æ ¸å¿ƒè®Šå‹•ï¼šå‹•æ…‹å‰µå»ºè¼¸å…¥æ¡† ğŸ”¥
        // -----------------------------------------------------------------
        function addRecordInput(initialContent = '', focus = true) {
            inputCounter++;
            const inputId = `recordInput-${inputCounter}`;
            const container = document.getElementById('recordInputsContainer');

            const newBlock = document.createElement('div');
            newBlock.className = 'record-input-block';
            newBlock.id = `block-${inputCounter}`;

            // å®Œæ•´çš„ Copilot çµæ§‹ HTML
            newBlock.innerHTML = `
                <button type="button" class="btn-remove-block" title="ç§»é™¤æ­¤ç´€éŒ„" onclick="removeRecordInput('${inputId}')">âŒ</button>
                <div class="copilot-container form-group">
                    <div id="overlay-${inputId}" class="suggestion-overlay"></div>
                    <textarea 
                        id="${inputId}"
                        class="record-textarea"
                        placeholder="è«‹è¼¸å…¥è­·ç†ç´€éŒ„å…§å®¹ (ä¾‹å¦‚ï¼šF) å‚·å£)" 
                        rows="8" 
                        required 
                        oninput="handleInput(this)" 
                        onkeydown="handleKeydown(event, this)"
                        onfocus="setFocusState(this)"
                    >${initialContent}</textarea>
                </div>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">å»ºè­° ${inputCounter}ï¼šæŒ‰ Tab æ¥å—ï¼Œâ†‘/â†“ åˆ‡æ›å»ºè­°ã€‚</p>
            `;

            container.appendChild(newBlock);

            // åˆå§‹åŒ–è©²è¼¸å…¥æ¡†çš„ AI ç‹€æ…‹
            inputStates.set(inputId, { suggestions: [], currentSuggestionIndex: 0 });
            
            // ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œç¢ºä¿ Overlay èˆ‡ Textarea åŒæ­¥æ»¾å‹•
            const inputEl = document.getElementById(inputId);
            const overlayEl = document.getElementById(`overlay-${inputId}`);
            inputEl.addEventListener('scroll', () => {
                overlayEl.scrollTop = inputEl.scrollTop;
                overlayEl.scrollLeft = inputEl.scrollLeft;
            });

            if (focus) {
                inputEl.focus();
            }
        }
        
        // ç§»é™¤è¼¸å…¥æ¡†
        function removeRecordInput(inputId) {
            if (document.querySelectorAll('.record-input-block').length <= 1) {
                alert('å¿…é ˆä¿ç•™è‡³å°‘ä¸€å€‹è­·ç†ç´€éŒ„å€å¡Šã€‚');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦ç§»é™¤æ­¤è­·ç†ç´€éŒ„å€å¡Šå—ï¼Ÿ')) {
                const blockId = inputId.split('-')[1];
                const block = document.getElementById(`block-${blockId}`);
                if (block) {
                    block.remove();
                    inputStates.delete(inputId);
                    
                    // é‡æ–°è¨­ç½®ç„¦é»åˆ°åˆ—è¡¨çš„ç¬¬ä¸€å€‹å…ƒç´ 
                    const remainingInputs = document.querySelectorAll('.record-textarea');
                    if (remainingInputs.length > 0) {
                         remainingInputs[0].focus();
                    }
                }
            }
        }
        
        // è¨˜éŒ„ç„¦é»ç‹€æ…‹ï¼Œé›–ç„¶ä¸æ˜¯å¿…éœ€ï¼Œä½†æœ‰åŠ©æ–¼é™¤éŒ¯
        function setFocusState(inputEl) {
             // ç¢ºä¿åœ¨æœ‰ç„¦é»æ™‚æ¸…é™¤å…¶ä»–è¼¸å…¥æ¡†çš„å»ºè­°æç¤ºï¼Œé¿å…å¹²æ“¾
             inputStates.forEach((state, key) => {
                 if (key !== inputEl.id && state.suggestions.length > 0) {
                     state.suggestions = [];
                     document.getElementById(`overlay-${key}`).innerHTML = '';
                 }
             });
        }


        // -----------------------------------------------------------------
        // è™•ç†è¼¸å…¥äº‹ä»¶ï¼šè§¸ç™¼é˜²æŠ– API å‘¼å« (æ›´æ–°ç‚ºå¤šè¼¸å…¥æ¡†æ¨¡å¼)
        // -----------------------------------------------------------------
        async function handleInput(inputEl) {
            const fullText = inputEl.value;
            const inputId = inputEl.id;
            const overlayEl = document.getElementById(`overlay-${inputId}`);
            let state = inputStates.get(inputId);
            
            if (!state) return; 

            state.suggestions = [];
            state.currentSuggestionIndex = 0;
            overlayEl.innerHTML = '';
            
            if (apiCallTimeouts.has(inputId)) {
                clearTimeout(apiCallTimeouts.get(inputId));
            }
            
            if (fullText.length < MIN_PROMPT_LENGTH) {
                 return;
            }
            
            apiCallTimeouts.set(inputId, setTimeout(async () => {
                showLoading('æ­£åœ¨å‘¼å« AI æ¨¡å‹...'); 
                try {
                    const result = await predictText(fullText); 
                    
                    if (result && result.alternatives && result.alternatives.length > 0) {
                        const filteredSuggestions = result.alternatives.filter(s => s.startsWith(fullText)); 

                        if (filteredSuggestions.length > 0) {
                            state.suggestions = filteredSuggestions;
                            state.currentSuggestionIndex = 0;
                            displayCurrentSuggestion(inputEl); 
                        }
                    } 
                } catch (error) {
                    // API éŒ¯èª¤æ™‚ä¸é¡¯ç¤ºä»»ä½•å»ºè­°
                    overlayEl.innerHTML = '';
                } finally {
                    hideLoading(); 
                }
            }, DEBOUNCE_DELAY));
        }

        // -----------------------------------------------------------------
        // è™•ç†æŒ‰éµäº‹ä»¶ï¼šTab (æ¥å—), Up/Down (åˆ‡æ›) (æ›´æ–°ç‚ºå¤šè¼¸å…¥æ¡†æ¨¡å¼)
        // -----------------------------------------------------------------
        function handleKeydown(event, inputEl) {
            const inputId = inputEl.id;
            let state = inputStates.get(inputId);
            
            if (!state || state.suggestions.length === 0) {
                 return; 
            }
            
            // åªæœ‰åœ¨æœ‰å»ºè­°æ™‚æ‰æ””æˆªæŒ‰éµäº‹ä»¶
            if (event.key === 'Tab' || event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();

                if (event.key === 'Tab') {
                    // æ¥å—å»ºè­°
                    const suggestion = state.suggestions[state.currentSuggestionIndex];
                    
                    inputEl.value = suggestion; 
                    
                    // æ¸…ç©ºå»ºè­°ç‹€æ…‹
                    state.suggestions = [];
                    state.currentSuggestionIndex = 0;
                    document.getElementById(`overlay-${inputId}`).innerHTML = '';
                    
                    inputEl.focus();
                    inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length);
                } 
                else {
                    // åˆ‡æ›å»ºè­°
                    if (event.key === 'ArrowUp') {
                        // å‘ä¸Šåˆ‡æ›ï¼šç´¢å¼•æ¸›ä¸€ï¼Œå¦‚æœåˆ°é ­å‰‡è·³åˆ°æœ«å°¾
                        state.currentSuggestionIndex = (state.currentSuggestionIndex - 1 + state.suggestions.length) % state.suggestions.length;
                    } else {
                        // å‘ä¸‹åˆ‡æ›ï¼šç´¢å¼•åŠ ä¸€ï¼Œå¦‚æœåˆ°æœ«å°¾å‰‡è·³åˆ°é–‹é ­
                        state.currentSuggestionIndex = (state.currentSuggestionIndex + 1) % state.suggestions.length;
                    }
                    
                    displayCurrentSuggestion(inputEl);
                }
            } 
        }

        // é¡¯ç¤ºç•¶å‰çš„å»ºè­° (æ›´æ–°ç‚ºå¤šè¼¸å…¥æ¡†æ¨¡å¼)
        function displayCurrentSuggestion(inputEl) {
            const inputId = inputEl.id;
            const overlayEl = document.getElementById(`overlay-${inputId}`);
            let state = inputStates.get(inputId);

            if (!state || state.suggestions.length === 0) {
                overlayEl.innerHTML = '';
                return;
            }
            
            const userText = inputEl.value;
            const currentSuggestion = state.suggestions[state.currentSuggestionIndex];
            
            if (currentSuggestion.startsWith(userText)) {
                
                const escapeHtml = (unsafe) => {
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                };
                
                const userTextEscaped = escapeHtml(userText);
                const currentSuggestionEscaped = escapeHtml(currentSuggestion);
                
                // æ‰¾åˆ°è£œå…¨çš„ç°è‰²æ–‡å­—éƒ¨åˆ†
                const ghostTextEscaped = currentSuggestionEscaped.substring(userTextEscaped.length);


                // ä½¿ç”¨é€æ˜æ–‡å­—ä½”ä½ï¼Œç¢ºä¿è¼¸å…¥å’Œè£œå…¨çš„å°é½Š
                const invisibleUserTextHtml = userTextEscaped.replace(/\n/g, '<br>');
                const userPrefix = `<span style="color: transparent;">${invisibleUserTextHtml}</span>`;
                
                const ghostSuffixHtml = ghostTextEscaped.replace(/\n/g, '<br>');
                
                // ğŸ’¡ æç¤ºä½¿ç”¨è€…ç•¶å‰å»ºè­°çš„åºè™Ÿ
                const hint = ` [${state.currentSuggestionIndex + 1}/${state.suggestions.length} â†‘â†“åˆ‡æ›]`;
                const ghostSuffix = `<span style="color: #ccc;">${ghostSuffixHtml}${hint}</span>`;
                
                overlayEl.style.whiteSpace = 'pre-wrap'; 
                overlayEl.innerHTML = userPrefix + ghostSuffix;

                // ç¢ºä¿ overlay æ»¾å‹•èˆ‡ input åŒæ­¥
                overlayEl.scrollTop = inputEl.scrollTop;
                overlayEl.scrollLeft = inputEl.scrollLeft;

            } else {
                overlayEl.innerHTML = '';
            }
        }
        
        // =================================================================
        // æ¨¡æ“¬è³‡æ–™åº«åŠå…¶ä»–åŠŸèƒ½ (å·²æ›´æ–°ç‚ºå¤šè¼¸å…¥æ¡†æ¨¡å¼)
        // =================================================================
        let currentEditingPatientId = null;
        
        let patientRecords = {}; 
        
        let currentUser = {
            id: 'N001',
            name: 'å¼µè­·ç†å¸«',
            position: 'è³‡æ·±è­·ç†å¸«',
            department: 'å…§ç§‘',
            email: 'nurse.chang@hospital.com',
            phone: '0912-345-678'
        };
        
        let patientList = [];

        
        function login(event) {
            event.preventDefault();
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            if (id && password) {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    
                    currentUser.id = id;
                    
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('login').classList.remove('active');
                    
                    initializeUserProfile();
                    updatePaginationInfo(); 
                    switchPage('patients'); 
                    showSuccessMessage('ç™»å…¥æˆåŠŸï¼æ­¡è¿å›ä¾†ã€‚');
                }, 1000);
            } else {
                alert('è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿå’Œå¯†ç¢¼ï¼');
            }
        }
        
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ')) {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('login').classList.add('active');
                    document.getElementById('loginPassword').value = ''; 
                    showSuccessMessage('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
                }, 1000);
            }
        }
        
        function initializeUserProfile() {
            const name = currentUser.name;
            const avatarLetter = name.charAt(0) || 'ï¼Ÿ';
            
            document.getElementById('navUserName').textContent = name + 'è­·ç†å¸«';
            document.getElementById('navUserDetail').textContent = `${currentUser.position} Â· ${currentUser.department}`;
            document.getElementById('navUserAvatar').textContent = avatarLetter;
            
            document.getElementById('settingUserAvatar').textContent = avatarLetter;
            document.getElementById('settingUserNameDisplay').textContent = name + 'è­·ç†å¸«';
            document.getElementById('settingUserDetailDisplay').textContent = `${currentUser.position} Â· ${currentUser.department}`;
            
            document.getElementById('settingNameInput').value = currentUser.name;
            document.getElementById('settingIdInput').value = currentUser.id;
            document.getElementById('settingEmailInput').value = currentUser.email;
            document.getElementById('settingPhoneInput').value = currentUser.phone;
            document.getElementById('settingPositionInput').value = currentUser.position;
            document.getElementById('settingDeptSelect').value = currentUser.department;
        }

        function updateProfileDisplay() {
            const nameInput = document.getElementById('settingNameInput').value;
            const positionInput = document.getElementById('settingPositionInput').value;
            const deptSelect = document.getElementById('settingDeptSelect').value;
            
            const avatarLetter = nameInput.charAt(0) || 'ï¼Ÿ';
            
            currentUser.name = nameInput;
            currentUser.position = positionInput;
            currentUser.department = deptSelect;

            document.getElementById('navUserName').textContent = nameInput + 'è­·ç†å¸«';
            document.getElementById('navUserDetail').textContent = `${positionInput} Â· ${deptSelect}`;
            document.getElementById('navUserAvatar').textContent = avatarLetter;
            
            document.getElementById('settingUserAvatar').textContent = avatarLetter;
            document.getElementById('settingUserNameDisplay').textContent = nameInput + 'è­·ç†å¸«';
            document.getElementById('settingUserDetailDisplay').textContent = `${positionInput} Â· ${deptSelect}`;
        }
        
        function saveSettings() {
             currentUser.email = document.getElementById('settingEmailInput').value;
             currentUser.phone = document.getElementById('settingPhoneInput').value;
             
             updateProfileDisplay(); 
             showSuccessMessage('å€‹äººè¨­å®šå·²å„²å­˜æ›´æ–°ï¼');
        }


        function switchPage(pageName) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            
            const targetPage = document.getElementById(pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.error('Page not found:', pageName);
                document.getElementById('patients').classList.add('active'); 
            }

            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        let currentPreviewingPatient = { name: null, id: null }; 
        function showPatientPreview(name, id) {
            currentPreviewingPatient = { name, id };
            document.getElementById('previewPatientName').textContent = name;
            
            renderPatientRecords(id);
            
            switchPage('patientRecordPreview');
        }
        
        function openRecordFormForPreview() {
            if (currentPreviewingPatient.id) {
                 openRecordForm(currentPreviewingPatient.name, currentPreviewingPatient.id);
            } else {
                 alert('éŒ¯èª¤ï¼šç„¡æ³•è­˜åˆ¥ç—…æ‚£ã€‚');
                 switchPage('patients');
            }
        }

        
        function renderPatientRecords(patientId) {
            const listContainer = document.getElementById('recordPreviewList');
            const records = (patientRecords[patientId] || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            listContainer.innerHTML = ''; 

            if (records.length === 0) {
                listContainer.innerHTML = '<p style="color: #666; text-align: center;">æ­¤ç—…æ‚£å°šç„¡è­·ç†ç´€éŒ„ã€‚</p>';
                return;
            } 
            
            records.forEach((record, index) => {
                const recordHtml = `
                    <div class="record-preview-item" data-record-index="${index}">
                        <div class="record-item-header">
                            <strong>${record.date}</strong>
                            <div class="record-actions">
                                <span>ç´€éŒ„äººï¼š${record.author}</span>
                                <button class="action-btn edit" title="ç·¨è¼¯" onclick="toggleEditRecord('${patientId}', ${index})">âœï¸</button>
                                <button class="action-btn delete" title="åˆªé™¤" onclick="deleteRecord('${patientId}', ${index})">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p id="record-content-${patientId}-${index}">${record.full}</p>
                        
                        <div class="record-edit-area" id="edit-area-${patientId}-${index}">
                            <textarea class="record-edit-textarea" id="edit-textarea-${patientId}-${index}">${record.full}</textarea>
                            <div class="record-edit-buttons">
                                <button class="btn btn-secondary" onclick="toggleEditRecord('${patientId}', ${index})">å–æ¶ˆ</button>
                                <button class="btn btn-primary" onclick="saveEditRecord('${patientId}', ${index})">å„²å­˜</button>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += recordHtml;
            });
        }
        
        function toggleEditRecord(patientId, index) {
            const editArea = document.getElementById(`edit-area-${patientId}-${index}`);
            const contentP = document.getElementById(`record-content-${patientId}-${index}`);
            const textarea = document.getElementById(`edit-textarea-${patientId}-${index}`);
            
            editArea.classList.toggle('active');
            contentP.style.display = editArea.classList.contains('active') ? 'none' : 'block';
            
            if (editArea.classList.contains('active')) {
                 textarea.value = patientRecords[patientId][index].full;
                 textarea.focus();
            }
        }
        
        function saveEditRecord(patientId, index) {
            const textarea = document.getElementById(`edit-textarea-${patientId}-${index}`);
            const newContent = textarea.value;
            
            if (!newContent.trim()) {
                 alert('ç´€éŒ„å…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
                 return;
            }
            
            if (confirm('ç¢ºå®šè¦å„²å­˜ç·¨è¼¯å¾Œçš„ç´€éŒ„å—ï¼Ÿ')) {
                showLoading();
                setTimeout(() => {
                     patientRecords[patientId][index].full = newContent;
                     
                     const now = new Date();
                     patientRecords[patientId][index].date = now.toLocaleString('zh-TW', { 
                         year: 'numeric', month: '2-digit', day: '2-digit', 
                         hour: '2-digit', minute: '2-digit', hour12: false
                     }).replace(/\//g, '-');
                     patientRecords[patientId][index].author = currentUser.name + 'è­·ç†å¸«' + ' (å·²ç·¨è¼¯)';
                     
                     renderPatientRecords(patientId);
                     hideLoading();
                     showSuccessMessage('è­·ç†ç´€éŒ„å·²æˆåŠŸç·¨è¼¯ä¸¦å„²å­˜ï¼');
                }, 1000);
            }
        }
        
        function deleteRecord(patientId, index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è­·ç†ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                showLoading();
                setTimeout(() => {
                    patientRecords[patientId].splice(index, 1);
                    
                    renderPatientRecords(patientId);
                    hideLoading();
                    showSuccessMessage('è­·ç†ç´€éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
                }, 1000);
            }
        }


        function openRecordForm(name, id) {
            currentEditingPatientId = id; 
            document.getElementById('formPatientName').textContent = name; 
            
            // ç¢ºä¿æ¯æ¬¡é–‹å•Ÿè¡¨å–®æ™‚éƒ½é‡ç½®ä¸¦åˆå§‹åŒ–è¼¸å…¥æ¡†
            resetForm(false); 
            
            document.getElementById('recordTime').value = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            // ç„¦é»å·²åœ¨ resetForm -> addRecordInput ä¸­è¨­ç½®

            switchPage('form');
        }

        function cancelRecordForm() {
            currentEditingPatientId = null; 
            switchPage('patients'); 
        }

        // ğŸ”¥ æ ¸å¿ƒè®Šå‹•ï¼šéæ­·æ‰€æœ‰è¼¸å…¥æ¡†ä¸¦åˆä½µå…§å®¹
        function submitForm(event) {
            event.preventDefault();
            
            const recordInputs = document.querySelectorAll('#recordInputsContainer .record-textarea');
            let finalRecordContent = '';
            let hasContent = false;
            
            // éæ­·æ‰€æœ‰è¼¸å…¥æ¡†ï¼Œç”¨å…©å€‹æ›è¡Œç¬¦è™Ÿåˆä½µå…§å®¹
            recordInputs.forEach(input => {
                const content = input.value.trim();
                if (content) {
                    if (finalRecordContent) {
                        finalRecordContent += '\n\n'; 
                    }
                    finalRecordContent += content;
                    hasContent = true;
                }
            });

            if (!hasContent) {
                alert('è«‹è¼¸å…¥è‡³å°‘ä¸€æ ¼è­·ç†ç´€éŒ„å…§å®¹ï¼');
                return;
            }

            const recordTimeInput = document.getElementById('recordTime').value;

            if (!recordTimeInput) {
                alert('è«‹è¼¸å…¥ç´€éŒ„æ™‚é–“ï¼');
                return;
            }
            
            if (!currentEditingPatientId) {
                alert('éŒ¯èª¤ï¼šæœªæŒ‡å®šç—…æ‚£ã€‚è«‹è¿”å›åˆ—è¡¨ä¸¦é‡æ–°é»é¸æŒ‰éˆ•ã€‚');
                return;
            }
            
            const formattedDate = new Date(recordTimeInput).toLocaleString('zh-TW', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', hour12: false
                }).replace(/\//g, '-');

            const newRecord = {
                date: formattedDate,
                author: currentUser.name + 'è­·ç†å¸«', 
                full: finalRecordContent // ä½¿ç”¨åˆä½µå¾Œçš„å…§å®¹
            };
            
            if (!patientRecords[currentEditingPatientId]) {
                patientRecords[currentEditingPatientId] = [];
            }
            patientRecords[currentEditingPatientId].unshift(newRecord); 
            
            showLoading();
            setTimeout(() => {
                hideLoading();
                showSuccessMessage('è­·ç†ç´€éŒ„å·²æˆåŠŸå„²å­˜ï¼');
                
                resetForm(false);
                currentEditingPatientId = null;
                
                setTimeout(() => {
                    switchPage('patients'); 
                }, 1000);
            }, 1500);
        }

        // ğŸ”¥ æ ¸å¿ƒè®Šå‹•ï¼šé‡ç½®æ™‚æ¸…ç©ºæ‰€æœ‰å‹•æ…‹å‰µå»ºçš„è¼¸å…¥æ¡†
        function resetForm(showConfirm = true) {
            let confirmed = true;
            if (showConfirm) {
                confirmed = confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¡¨å–®å…§å®¹å—ï¼Ÿæ­¤æ“ä½œæœƒç§»é™¤æ‰€æœ‰æ–°å¢çš„ç´€éŒ„å€å¡Šï¼');
            }
            
            if (confirmed) {
                document.getElementById('recordForm').reset(); 
                
                // 1. æ¸…ç©ºæ‰€æœ‰å‹•æ…‹è¼¸å…¥å’Œç‹€æ…‹
                const container = document.getElementById('recordInputsContainer');
                container.innerHTML = '';
                inputStates.clear();
                apiCallTimeouts.clear();
                inputCounter = 0; // é‡ç½®è¨ˆæ•¸å™¨
                
                // 2. é‡æ–°å»ºç«‹åˆå§‹çš„ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
                addRecordInput(); 
            }
        }


        
        function submitNewPatient(event) {
            event.preventDefault();
            showLoading();

            const name = document.getElementById('newPatientName').value;
            const id = document.getElementById('newPatientId').value;
            
            if (patientRecords.hasOwnProperty(id)) {
                 hideLoading();
                 alert('éŒ¯èª¤ï¼šç—…æ­·è™Ÿ ' + id + ' å·²å­˜åœ¨ï¼');
                 return;
            }

            const age = document.getElementById('newPatientAge').value;
            const gender = document.getElementById('newPatientGender').value;
            const bed = document.getElementById('newPatientBed').value;
            const dept = document.getElementById('newPatientDept').value;
            const diagnosis = document.getElementById('newPatientDiagnosis').value;
            const risk = document.getElementById('newPatientRisk').value;
            const doctor = document.getElementById('newPatientDoctor').value;
            let admissionDate = document.getElementById('newPatientAdmissionDate').value;
            
            if (!admissionDate) {
                admissionDate = new Date().toISOString().split('T')[0]; 
            }
            
            const newPatient = {
                id, name, age, gender, bed, dept, diagnosis, risk, doctor, admissionDate
            };
            
            patientRecords[id] = []; 
            patientList.unshift(newPatient); 
            
            renderPatientTable(patientList); 

            setTimeout(() => {
                hideLoading();
                showSuccessMessage('ç—…æ‚£å·²æˆåŠŸæ–°å¢ï¼');
                document.getElementById('newPatientForm').reset();
                updatePaginationInfo(); 
                switchPage('patients');
            }, 1000);
        }
        
        function renderPatientTable(listToRender) {
            const tableBody = document.getElementById('patientTableBody');
            tableBody.innerHTML = ''; 
            
            listToRender.forEach(p => {
                 const newRow = tableBody.insertRow(); 
                 const avatarLetter = p.name.charAt(0) || 'ï¼Ÿ';
                 const riskBadgeClass = getRiskBadgeClass(p.risk);
                 const doctorEmoji = 'ğŸ‘¨â€âš•ï¸'; 
                 const patientDetails = `${p.id} Â· ${p.age}æ­² Â· ${p.gender}`;

                 newRow.innerHTML = `
                     <td>
                         <div class="patient-info">
                             <div class="patient-avatar">${avatarLetter}</div>
                             <div class="patient-details">
                                 <div class="name">${p.name}</div>
                                 <div class="id">${patientDetails}</div>
                             </div>
                         </div>
                     </td>
                     <td>ğŸ“ ${p.bed}</td>
                     <td>${p.dept}</td>
                     <td>${p.diagnosis}</td>
                     <td><span class${riskBadgeClass}>${p.risk}</span></td>
                     <td>${doctorEmoji} ${p.doctor}</td>
                     <td>ğŸ“… ${p.admissionDate}</td>
                     <td>
                         <div class="action-buttons">
                             <button class="action-btn view" title="æª¢è¦–ç´€éŒ„" onclick="showPatientPreview('${p.name}', '${p.id}')">ğŸ‘ï¸</button>
                             <button class="action-btn edit" title="æ–°å¢ç´€éŒ„" onclick="openRecordForm('${p.name}', '${p.id}')">âœï¸</button>
                         </div>
                     </td>
                 `;
            });
            updatePaginationInfo();
            
            if (listToRender.length === 0) {
                 const noResultRow = tableBody.insertRow();
                 noResultRow.innerHTML = `<td colspan="8" style="text-align: center; color: #999; padding: 30px;">æŸ¥ç„¡ç›¸ç¬¦çš„ç—…æ‚£è³‡æ–™ã€‚</td>`;
            }
        }
        
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                 renderPatientTable(patientList);
                 return;
            }

            const searchResult = patientList.filter(p => 
                 p.name.toLowerCase().includes(searchTerm) || 
                 p.id.toLowerCase().includes(searchTerm)
            );
            
            renderPatientTable(searchResult);
            
            if (searchResult.length === 0) {
                 alert('æŸ¥ç„¡æ­¤äººï¼šæ²’æœ‰æ‰¾åˆ°ç¬¦åˆ ' + searchTerm + ' çš„ç—…æ‚£ã€‚');
            }
        }
        

        function getRiskBadgeClass(riskLevel) {
            switch(riskLevel) {
                case 'é«˜é¢¨éšª':
                    return '="status-badge" style="background: #fee2e2; color: #991b1b;"';
                case 'ä¸­é¢¨éšª':
                    return '="status-badge status-pending"';
                case 'ä½é¢¨éšª':
                    return '="status-badge status-completed"';
                default:
                    return '="status-badge"';
            }
        }


        
        function updatePaginationInfo() {
            const rowCount = patientList.length; 
            const infoEl = document.querySelector('.pagination-info');
            
            if (rowCount === 0) {
                infoEl.textContent = 'ç›®å‰ç„¡ç—…æ‚£è³‡æ–™';
            } else {
                infoEl.textContent = `é¡¯ç¤º 1 åˆ° ${rowCount} ç­†ï¼Œå…± ${rowCount} ç­†ç—…æ‚£è³‡æ–™`;
            }
        }
        
        function showLoading(text = 'è™•ç†ä¸­...') {
            const loadingEl = document.getElementById('loading');
            let textEl = loadingEl.querySelector('.loading-text');
            if (!textEl) {
                 textEl = document.createElement('div');
                 textEl.className = 'loading-text';
                 textEl.style.marginTop = '20px';
                 textEl.style.fontSize = '16px';
                 textEl.style.color = '#667eea';
                 loadingEl.appendChild(textEl);
            }
            textEl.textContent = text;
            loadingEl.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showSuccessMessage(messageText) {
            const successMsg = document.getElementById('successMessage');
            
            const p = successMsg.querySelector('p');
            if (p) {
                p.textContent = messageText || 'æ“ä½œå·²å®Œæˆ';
            }

            successMsg.classList.remove('hide');
            successMsg.classList.add('show');
            
            setTimeout(() => {
                successMsg.classList.remove('show');
                successMsg.classList.add('hide');
                setTimeout(() => {
                    successMsg.classList.remove('hide');
                }, 500);
            }, 3000);
        }

        // åˆå§‹è¼‰å…¥æ™‚
        document.addEventListener('DOMContentLoaded', (event) => {
            patientList.push({
                 id: 'P001', name: 'ç‹å°æ˜', age: 65, gender: 'ç”·', bed: 'A101-2', dept: 'å…§ç§‘', 
                 diagnosis: 'è‚ºç‚ä½µç™¼æ•—è¡€ç—‡', risk: 'é«˜é¢¨éšª', doctor: 'é™³å¤§é†«', admissionDate: '2025-11-01'
            });
            // ç”±æ–¼ç´€éŒ„å…§å®¹ç¾åœ¨æœƒè¢«åˆä½µï¼Œé€™è£¡çš„å…§å®¹ä¹Ÿç¨å¾®ä¿®æ”¹ä¸€ä¸‹
            patientRecords['P001'] = [
                 { date: '2025-11-05 10:30', author: 'å¼µè­·ç†å¸«', full: 'F) å‘¼å¸æ€¥ä¿ƒèˆ‡ä½è¡€æ°§ã€‚D) Spo2 90%ï¼Œå‘¼å¸æ·ºå¿«ï¼Œé›™å´è‚ºéƒ¨è½è¨ºæœ‰å›‰éŸ³ã€‚\n\n[DART ç´€éŒ„ 2]\nA) å‘¼å¸å‹æ…‹æ”¹è®Šã€‚\nR) çµ¦äºˆæ°§æ°£é¼»å°ç®¡ 2L/minï¼Œå”åŠ©æ¡åŠåè‡¥ã€‚\nT) ç«‹å³é€šçŸ¥é†«å¸«ï¼Œç›£æ¸¬ Spo2 è®ŠåŒ–ã€‚' },
                 { date: '2025-11-04 18:00', author: 'æè­·ç†å¸«', full: 'F) é£²é£Ÿèˆ‡ç‡Ÿé¤Šã€‚\n\nD) ç—…æ‚£ä¸»è¨´ã€Œè‚šå­æœ‰é»é¤“ã€ï¼Œé€²é£Ÿæ¸…ç²¥åŠç¢—ï¼Œç”Ÿå‘½å¾µè±¡ç©©å®šã€‚\nA) ç‹€æ³ç©©å®šï¼Œæ¢å¾©æœŸã€‚' }
            ];
            
            renderPatientTable(patientList);
        });
    </script>


</body></html>
